# Implementation Plan: Testing — Backend + Frontend Tests

**Branch**: `008-testing-strategy` | **Date**: 2026-02-08 | **Spec**: [specs/008-testing-strategy/spec.md](../../specs/008-testing-strategy/spec.md)
**Input**: Feature specification from `/specs/008-testing-strategy/spec.md`

## Summary

Implement the complete test suite for the Phase II Todo Full-Stack Web Application covering 72 functional requirements (FR-001 through FR-072). Backend tests use pytest + httpx AsyncClient with SQLite in-memory database and mock JWT tokens. Frontend tests use Vitest + React Testing Library with mocked auth and API dependencies. All features are already implemented — this plan produces tests only.

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript 5+ (frontend)
**Primary Dependencies**: pytest 8+, pytest-asyncio 0.24+, httpx 0.27+, pytest-cov (backend); vitest, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event, jsdom (frontend)
**Storage**: SQLite in-memory (test substitute for Neon PostgreSQL)
**Testing**: pytest (backend), Vitest (frontend)
**Target Platform**: Windows dev machine, CI
**Project Type**: Web application (monorepo)
**Performance Goals**: Backend suite < 60s, Frontend suite < 30s
**Constraints**: No external service dependencies, no production DB access, test isolation
**Scale/Scope**: ~45 backend tests, ~27 frontend tests = ~72 total

## Constitution Check

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Spec-Driven Development | PASS | Spec at `specs/008-testing-strategy/spec.md` with 72 FRs |
| II. No Manual Coding | PASS | All code generated by agents from this plan |
| III. User Isolation | PASS | Tests explicitly verify user_id filtering (FR-008, FR-025, FR-039) |
| IV. Clean Architecture | PASS | Service layer tested independently from routes |
| V. Monorepo Coherence | PASS | Both backend and frontend tested in one plan |

## Project Structure

### Documentation (this feature)

```text
specs/008-testing-strategy/
├── spec.md              # Feature specification (72 FRs)
├── checklists/
│   └── requirements.md  # Quality checklist
└── plan.md              # Existing partial plan (superseded by this file)

.specify/plans/
└── plan-testing.md      # This file — comprehensive implementation plan
```

### Source Code (test files to create)

```text
backend/
├── tests/
│   ├── __init__.py          # Already exists
│   ├── conftest.py          # NEW — fixtures, test DB, mock JWT, AsyncClient
│   ├── test_auth.py         # NEW — FR-001 through FR-006 (6 tests)
│   ├── test_tasks.py        # NEW — FR-007 through FR-038 (32 tests)
│   └── test_service.py      # NEW — FR-039 through FR-045 (7 tests)
└── pyproject.toml           # UPDATE — add pytest-cov dependency

frontend/
├── vitest.config.ts         # NEW — Vitest configuration
├── vitest.setup.ts          # NEW — React Testing Library setup + jsdom
├── __tests__/
│   ├── components/
│   │   ├── TaskList.test.tsx    # NEW — FR-046 through FR-048
│   │   ├── TaskItem.test.tsx    # NEW — FR-049 through FR-051
│   │   ├── TaskForm.test.tsx    # NEW — FR-052 through FR-055
│   │   ├── LoginForm.test.tsx   # NEW — FR-056 through FR-058
│   │   └── SignupForm.test.tsx  # NEW — FR-059 through FR-061
│   └── lib/
│       └── api.test.ts          # NEW — FR-062 through FR-063
├── __mocks__/
│   ├── next/
│   │   └── navigation.ts       # NEW — mock useRouter, redirect
│   └── hooks/
│       └── useAuth.ts           # NEW — mock useAuth hook
├── package.json             # UPDATE — add vitest + testing-library deps + test script
└── tsconfig.json            # MAY UPDATE — ensure paths resolve for tests
```

---

## Phase 1: Backend Test Setup (conftest.py)

### Task 1.1: Add pytest-cov to backend dependencies

**File**: `backend/pyproject.toml`
**Change**: Add `pytest-cov>=5.0.0` to `[project.optional-dependencies].dev`

### Task 1.2: Create conftest.py with all fixtures

**File**: `backend/tests/conftest.py`
**FR Coverage**: FR-064, FR-065, FR-066

**Fixtures to implement:**

#### 1.2a — SQLite test engine and session override

```python
# Key design decisions:
# - Use SQLite in-memory (sqlite:///) NOT Neon PostgreSQL
# - Create all tables before each test session, drop after
# - Override FastAPI's get_session dependency to use test session
# - The Task model references FK "user.id" — we need to create a
#   minimal user table in SQLite to satisfy the FK constraint

import os
os.environ["DATABASE_URL"] = "sqlite://"  # Prevent db.py from raising
os.environ["BETTER_AUTH_SECRET"] = "test-secret-minimum-32-characters-long"
os.environ["CORS_ORIGINS"] = "http://localhost:3000"

from sqlmodel import SQLModel, Session, create_engine
from sqlalchemy import Column, String, Table

TEST_ENGINE = create_engine("sqlite://", echo=False)

# Create a minimal 'user' table to satisfy FK from tasks.user_id
user_table = Table(
    "user",
    SQLModel.metadata,
    Column("id", String, primary_key=True),
    extend_existing=True,
)

@pytest.fixture(name="session")
def session_fixture():
    SQLModel.metadata.create_all(TEST_ENGINE)
    with Session(TEST_ENGINE) as session:
        yield session
    SQLModel.metadata.drop_all(TEST_ENGINE)
```

#### 1.2b — Mock JWT token helper

```python
import jwt
from datetime import datetime, timezone, timedelta

TEST_SECRET = "test-secret-minimum-32-characters-long"
TEST_USER_ID = "test-user-123"
OTHER_USER_ID = "other-user-456"

def create_test_token(
    user_id: str = TEST_USER_ID,
    secret: str = TEST_SECRET,
    expired: bool = False,
) -> str:
    now = datetime.now(timezone.utc)
    payload = {
        "sub": user_id,
        "email": f"{user_id}@test.com",
        "name": "Test User",
        "iat": now,
        "exp": now + timedelta(hours=-1 if expired else 1),
    }
    return jwt.encode(payload, secret, algorithm="HS256")
```

#### 1.2c — AsyncClient fixture with dependency override

```python
import pytest
from httpx import AsyncClient, ASGITransport
from app.main import app
from app.db import get_session

@pytest.fixture(name="client")
async def client_fixture(session):
    def override_session():
        yield session

    app.dependency_overrides[get_session] = override_session
    transport = ASGITransport(app=app)
    async with AsyncClient(transport=transport, base_url="http://test") as client:
        yield client
    app.dependency_overrides.clear()
```

#### 1.2d — Auth header helper

```python
def auth_headers(user_id: str = TEST_USER_ID) -> dict:
    token = create_test_token(user_id=user_id)
    return {"Authorization": f"Bearer {token}"}
```

**Critical implementation note**: The `backend/app/db.py` module reads `DATABASE_URL` at import time and raises `ValueError` if empty. The conftest.py MUST set `os.environ["DATABASE_URL"]` BEFORE any app imports. Similarly, `config.py` reads `BETTER_AUTH_SECRET` at import time via `settings = Settings.from_env()`. All env vars must be set at the top of conftest.py before imports.

**Critical implementation note 2**: The `auth.py` middleware reads `BETTER_AUTH_SECRET = os.environ.get("BETTER_AUTH_SECRET", "")` at module level. Since conftest.py sets the env var before import, the middleware will use the test secret. However, if the module was already imported, the value is cached. We must either: (a) ensure conftest.py env setup runs before any app import, or (b) monkeypatch `app.middleware.auth.BETTER_AUTH_SECRET` in the fixture. Approach (a) is simpler — put env setup at the very top of conftest.py file scope (not inside a fixture).

---

## Phase 2: Backend Auth Tests (test_auth.py)

**File**: `backend/tests/test_auth.py`
**FR Coverage**: FR-001 through FR-006

Uses any protected endpoint (GET `/api/{user_id}/tasks`) as the test target.

| Test Function | FR | Input | Expected |
|--------------|-----|-------|----------|
| `test_no_token_returns_401` | FR-001 | No Authorization header | 401/403 (HTTPBearer returns 403 for missing) |
| `test_malformed_token_returns_401` | FR-002 | `Authorization: Bearer not-a-jwt` | 401 |
| `test_expired_token_returns_401` | FR-003 | Token with past expiry | 401 |
| `test_wrong_secret_returns_401` | FR-004 | Token signed with `wrong-secret` | 401 |
| `test_user_id_mismatch_returns_403` | FR-005 | Valid token for `user-A`, URL has `user-B` | 403 |
| `test_valid_token_matching_user_returns_200` | FR-006 | Valid token, matching URL user_id | 200 |

**Note on FR-001**: FastAPI's `HTTPBearer` dependency returns 403 (not 401) when no credentials are provided. The test should verify the request is rejected (status >= 400). If the spec strictly requires 401, we may need to customize the HTTPBearer or add a note. We'll verify the actual behavior during implementation and adjust.

---

## Phase 3: Backend CRUD Tests (test_tasks.py)

**File**: `backend/tests/test_tasks.py`
**FR Coverage**: FR-007 through FR-038

All tests use `auth_headers()` from conftest and the AsyncClient fixture.

### 3.1 — GET List Tests (FR-007 through FR-015)

| Test | FR | Description |
|------|-----|-------------|
| `test_list_tasks_empty` | FR-007 | No tasks → empty array `[]` |
| `test_list_tasks_user_isolation` | FR-008 | Create tasks for 2 users, list returns only authed user's |
| `test_list_tasks_filter_pending` | FR-009 | Mix of completed/pending → `?status=pending` returns only pending |
| `test_list_tasks_filter_completed` | FR-010 | `?status=completed` returns only completed |
| `test_list_tasks_filter_all` | FR-011 | `?status=all` returns everything |
| `test_list_tasks_sort_created` | FR-012 | `?sort=created` → newest first |
| `test_list_tasks_sort_title` | FR-013 | `?sort=title` → alphabetical |
| `test_list_tasks_invalid_status` | FR-014 | `?status=invalid` → 422 |
| `test_list_tasks_invalid_sort` | FR-015 | `?sort=invalid` → 422 |

### 3.2 — POST Create Tests (FR-016 through FR-022)

| Test | FR | Description |
|------|-----|-------------|
| `test_create_task_valid_title` | FR-016 | `{"title": "Test"}` → 201 |
| `test_create_task_with_description` | FR-017 | `{"title": "T", "description": "D"}` → 201 |
| `test_create_task_empty_title` | FR-018 | `{"title": ""}` → 422 |
| `test_create_task_missing_title` | FR-019 | `{}` → 422 |
| `test_create_task_title_too_long` | FR-020 | title 201 chars → 422 |
| `test_create_task_default_incomplete` | FR-021 | Created task has `completed: false` |
| `test_create_task_correct_user_id` | FR-022 | Created task has `user_id` matching auth user |

### 3.3 — GET Single Task Tests (FR-023 through FR-025)

| Test | FR | Description |
|------|-----|-------------|
| `test_get_task_found` | FR-023 | Valid task ID → 200 with task data |
| `test_get_task_not_found` | FR-024 | Non-existent ID → 404 |
| `test_get_task_other_user` | FR-025 | Task belongs to other user → 404 (not 403) |

### 3.4 — PUT Update Tests (FR-026 through FR-031)

| Test | FR | Description |
|------|-----|-------------|
| `test_update_task_title_only` | FR-026 | `{"title": "New"}` → 200, title changed |
| `test_update_task_description_only` | FR-027 | `{"description": "New"}` → 200, description changed |
| `test_update_task_both_fields` | FR-028 | Both fields → 200 |
| `test_update_task_timestamp_changes` | FR-029 | `updated_at` different after update |
| `test_update_task_not_found` | FR-030 | Non-existent ID → 404 |
| `test_update_task_empty_title` | FR-031 | `{"title": ""}` → 422 |

### 3.5 — DELETE Tests (FR-032 through FR-034)

| Test | FR | Description |
|------|-----|-------------|
| `test_delete_task_success` | FR-032 | Valid task → 204, no body |
| `test_delete_task_not_found` | FR-033 | Non-existent ID → 404 |
| `test_delete_task_no_longer_in_list` | FR-034 | After delete, GET list doesn't include it |

### 3.6 — PATCH Toggle Completion Tests (FR-035 through FR-038)

| Test | FR | Description |
|------|-----|-------------|
| `test_toggle_pending_to_completed` | FR-035 | `completed: false` → toggle → `completed: true` |
| `test_toggle_completed_to_pending` | FR-036 | `completed: true` → toggle → `completed: false` |
| `test_toggle_timestamp_changes` | FR-037 | `updated_at` changes after toggle |
| `test_toggle_not_found` | FR-038 | Non-existent ID → 404 |

**Helper function for tests:**

```python
async def create_task_for_user(client, user_id, title="Test Task", description=None):
    """Helper to create a task and return the response JSON."""
    payload = {"title": title}
    if description:
        payload["description"] = description
    response = await client.post(
        f"/api/{user_id}/tasks",
        json=payload,
        headers=auth_headers(user_id),
    )
    return response.json()
```

---

## Phase 4: Backend Service Tests (test_service.py)

**File**: `backend/tests/test_service.py`
**FR Coverage**: FR-039 through FR-045

These are unit tests that call service functions directly with a SQLModel Session (not through HTTP). They verify business logic in isolation.

| Test | FR | Description |
|------|-----|-------------|
| `test_get_tasks_filters_by_user_id` | FR-039 | Create tasks for 2 users, `get_tasks(session, user_a)` returns only user_a's |
| `test_get_tasks_filters_by_status` | FR-040 | `get_tasks(session, user, status="pending")` returns only pending |
| `test_get_tasks_sorts_correctly` | FR-041 | `sort="title"` → alphabetical, `sort="created"` → newest first |
| `test_create_task_defaults` | FR-042 | `create_task` returns task with `completed=False`, timestamps set |
| `test_update_task_partial` | FR-043 | `update_task` with only `title` in `fields_set` changes only title |
| `test_delete_task_returns_bool` | FR-044 | Existing → `True`, non-existent → `False` |
| `test_toggle_complete_flips` | FR-045 | `False→True`, then `True→False` |

**Setup**: Each test creates tasks directly via the service layer, using the Session fixture from conftest.py. Need to insert a test user row into the `user` table first to satisfy FK constraint.

```python
from sqlalchemy import text

def seed_test_user(session, user_id="test-user-123"):
    session.exec(text(f"INSERT OR IGNORE INTO user (id) VALUES ('{user_id}')"))
    session.commit()
```

---

## Phase 5: Frontend Test Setup

### Task 5.1: Install test dependencies

**File**: `frontend/package.json`
**Change**: Add to `devDependencies`:
- `vitest`
- `@testing-library/react`
- `@testing-library/jest-dom`
- `@testing-library/user-event`
- `@vitejs/plugin-react` (for JSX transform in tests)
- `jsdom`

Add to `scripts`:
- `"test": "vitest run"`
- `"test:watch": "vitest"`
- `"test:coverage": "vitest run --coverage"`

### Task 5.2: Create Vitest config

**File**: `frontend/vitest.config.ts`

```typescript
import { defineConfig } from "vitest/config";
import react from "@vitejs/plugin-react";
import path from "path";

export default defineConfig({
  plugins: [react()],
  test: {
    environment: "jsdom",
    setupFiles: ["./vitest.setup.ts"],
    globals: true,
    css: false,
    alias: {
      "@": path.resolve(__dirname, "."),
    },
  },
});
```

### Task 5.3: Create setup file

**File**: `frontend/vitest.setup.ts`

```typescript
import "@testing-library/jest-dom/vitest";
```

### Task 5.4: Create mock modules

**File**: `frontend/__mocks__/next/navigation.ts`
```typescript
export const useRouter = vi.fn(() => ({
  push: vi.fn(),
  replace: vi.fn(),
  back: vi.fn(),
  refresh: vi.fn(),
}));
export const usePathname = vi.fn(() => "/");
export const redirect = vi.fn();
```

**File**: `frontend/__mocks__/hooks/useAuth.ts`
```typescript
export const useAuth = vi.fn(() => ({
  session: { user: { id: "test-user-123", name: "Test", email: "test@test.com" } },
  isLoading: false,
  isAuthenticated: true,
  signUp: vi.fn(),
  signIn: vi.fn(),
  signOut: vi.fn(),
  getToken: vi.fn().mockResolvedValue("mock-token"),
}));
```

---

## Phase 6: Frontend Component Tests

### Task 6.1: TaskList.test.tsx (FR-046, FR-047, FR-048)

| Test | FR | Description |
|------|-----|-------------|
| `renders task items when given tasks` | FR-046 | Pass 3 tasks → 3 TaskItem elements rendered |
| `renders empty state when no tasks` | FR-047 | Pass `[]` → "No tasks yet" message |
| `renders loading skeletons when loading` | FR-048 | `isLoading=true` → 3 animated pulse elements |

**Mock strategy**: Import TaskList directly. Pass mock functions for `onToggle`, `onEdit`, `onDelete`, `onRetry`. Mock TaskItem if needed, or let it render naturally.

### Task 6.2: TaskItem.test.tsx (FR-049, FR-050, FR-051)

| Test | FR | Description |
|------|-----|-------------|
| `displays title and completion status` | FR-049 | Render with task data → title visible, checkbox state matches |
| `completed task has visual distinction` | FR-050 | `completed=true` → `line-through` class present |
| `delete button triggers callback` | FR-051 | Click Delete → `onDelete(task.id)` called (mock `window.confirm` to return true) |

### Task 6.3: TaskForm.test.tsx (FR-052, FR-053, FR-054, FR-055)

| Test | FR | Description |
|------|-----|-------------|
| `create mode shows empty fields and Add Task` | FR-052 | `mode="create"` → inputs empty, button says "Add Task" |
| `edit mode shows prefilled fields and Update Task` | FR-053 | `mode="edit"` with initialData → fields filled, "Update Task" |
| `empty title shows validation error` | FR-054 | Submit with blank → "Title is required" error |
| `valid title triggers onSubmit` | FR-055 | Type title, submit → `onSubmit` called with data |

### Task 6.4: LoginForm.test.tsx (FR-056, FR-057, FR-058)

| Test | FR | Description |
|------|-----|-------------|
| `renders email and password inputs` | FR-056 | Both inputs present with correct types |
| `form submission calls signIn` | FR-057 | Fill and submit → `signIn(email, password)` called |
| `failed signin shows error` | FR-058 | Mock signIn to return error → error message visible |

**Mock strategy**: Mock `@/hooks/useAuth` to control `signIn` behavior. Mock `next/navigation` for `useRouter`.

### Task 6.5: SignupForm.test.tsx (FR-059, FR-060, FR-061)

| Test | FR | Description |
|------|-----|-------------|
| `renders name, email, password inputs` | FR-059 | All 3 inputs present |
| `form submission calls signUp` | FR-060 | Fill and submit → `signUp(email, password, name)` called |
| `duplicate email shows error` | FR-061 | Mock signUp to return error → error message visible |

---

## Phase 7: Frontend API Client Tests

**File**: `frontend/__tests__/lib/api.test.ts`
**FR Coverage**: FR-062, FR-063

| Test | FR | Description |
|------|-----|-------------|
| `attaches Bearer token to requests` | FR-062 | Mock `authClient.token()` → fetch called with `Authorization: Bearer <token>` |
| `redirects to login on 401` | FR-063 | Mock fetch to return 401 → `window.location.href` set to `/login` |

**Mock strategy**: Mock `@/lib/auth-client` module to control `authClient.token()`. Mock global `fetch` to inspect headers and simulate 401 responses.

---

## Implementation Order & Dependencies

```
Phase 1 (Backend Setup)
    ├── Task 1.1: Add pytest-cov dep
    └── Task 1.2: Create conftest.py
         │
         ├── Phase 2 (Auth Tests) ─── test_auth.py
         ├── Phase 3 (CRUD Tests) ─── test_tasks.py
         └── Phase 4 (Service Tests) ── test_service.py

Phase 5 (Frontend Setup)
    ├── Task 5.1: Install deps
    ├── Task 5.2: Vitest config
    ├── Task 5.3: Setup file
    └── Task 5.4: Mock modules
         │
         ├── Phase 6 (Component Tests) ─ 5 test files
         └── Phase 7 (API Client Tests) ─ api.test.ts
```

**Backend phases (1-4)** and **Frontend phases (5-7)** are independent and can be developed in parallel.

Within backend: Phase 1 must complete first, then Phases 2-4 can proceed in parallel.
Within frontend: Phase 5 must complete first, then Phases 6-7 can proceed in parallel.

---

## Coverage Targets (FR-068 through FR-072)

| Target | FR | Metric | How Measured |
|--------|-----|--------|-------------|
| Route handlers ≥ 90% | FR-068 | Line coverage on `app/routes/tasks.py` | `pytest --cov=app.routes --cov-report=term-missing` |
| Service layer ≥ 90% | FR-069 | Line coverage on `app/services/task_service.py` | `pytest --cov=app.services --cov-report=term-missing` |
| Auth middleware = 100% | FR-070 | Line coverage on `app/middleware/auth.py` | `pytest --cov=app.middleware --cov-report=term-missing` |
| Frontend components ≥ 60% | FR-071 | Line coverage on `components/` | `vitest run --coverage` |
| Frontend API client ≥ 80% | FR-072 | Line coverage on `lib/api.ts` | `vitest run --coverage` |

---

## Run Commands

```bash
# Backend tests
cd backend && uv pip install -e ".[dev]" && pytest -v --cov=app --cov-report=term-missing

# Frontend tests
cd frontend && npm install && npm test

# Frontend with coverage
cd frontend && npx vitest run --coverage
```

---

## Risk Analysis

1. **SQLite vs PostgreSQL dialect differences**: SQLite doesn't support all PostgreSQL features. Risk: queries that work in prod may behave differently in tests. Mitigation: our queries are simple (SELECT, INSERT, UPDATE, DELETE with WHERE) — no PG-specific features used.

2. **FastAPI HTTPBearer returns 403 for missing credentials (not 401)**: This is FastAPI/Starlette default behavior. FR-001 specifies 401. Mitigation: verify actual behavior during implementation. If 403, either accept it (security boundary still enforced) or customize the HTTPBearer scheme.

3. **Module-level env var reads**: `db.py`, `config.py`, and `auth.py` all read env vars at import time. If conftest.py doesn't set them before imports, tests will crash. Mitigation: conftest.py sets all env vars at file scope, before any `from app` import.

---

## Acceptance Criteria

- [ ] `cd backend && pytest -v` — all tests pass, 0 failures
- [ ] `cd backend && pytest --cov=app --cov-report=term-missing` — routes ≥ 90%, services ≥ 90%, middleware = 100%
- [ ] `cd frontend && npm test` — all tests pass, 0 failures
- [ ] `cd frontend && npx vitest run --coverage` — components ≥ 60%, api client ≥ 80%
- [ ] No test depends on execution order (FR-064)
- [ ] No test depends on external services (FR-066)
- [ ] Backend suite completes in < 60 seconds (SC-008)
- [ ] Frontend suite completes in < 30 seconds (SC-009)
