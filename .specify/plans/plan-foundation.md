# Implementation Plan: Foundation — Database Schema + Authentication Setup

**Branch**: `009-foundation` | **Date**: 2026-02-08 | **Specs**: 001-system-architecture, 002-database-schema, 003-auth-system
**Input**: Specs from `specs/001-system-architecture/spec.md`, `specs/002-database-schema/spec.md`, `specs/003-auth-system/spec.md`

## Summary

Implement the foundation layer: Neon PostgreSQL connection with SQLModel, Task model and schemas, Better Auth with JWT plugin on the frontend, and PyJWT verification middleware on the backend. No task endpoints — just the infrastructure that all future features depend on.

## Technical Context

**Language/Version**: Python 3.13 (backend), TypeScript (frontend, Next.js 16+)
**Primary Dependencies**: FastAPI, SQLModel, PyJWT (backend); Better Auth, pg (frontend)
**Storage**: Neon Serverless PostgreSQL with SSL (`sslmode=require`)
**Testing**: pytest + httpx (backend), Vitest (frontend) — deferred to testing feature
**Target Platform**: Web application (localhost dev, Vercel/cloud deploy)
**Project Type**: Web (monorepo: `frontend/` + `backend/`)
**Performance Goals**: API responses < 1 second, page loads < 3 seconds
**Constraints**: Hackathon scope, single-digit concurrent users, no migration tooling needed
**Scale/Scope**: 2 services, 1 database, < 10 screens

## Constitution Check

*GATE: Must pass before implementation.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Spec-Driven Development | PASS | Specs 001, 002, 003 approved and committed |
| II. No Manual Coding | PASS | All code will be generated by agents from this plan |
| III. User Isolation | PASS | Task model includes `user_id` FK; all queries will filter by user_id |
| IV. Clean Architecture | PASS | Thin routes → service layer → models; separate schemas for create/update/response |
| V. Monorepo Coherence | PASS | Shared `BETTER_AUTH_SECRET`, shared `DATABASE_URL`, documented in .env.example |

No violations. No complexity tracking needed.

## Project Structure

### Source Code

```text
backend/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI app, CORS, lifespan, health check
│   ├── config.py            # Settings from env vars
│   ├── db.py                # Neon engine + session dependency
│   ├── models/
│   │   ├── __init__.py
│   │   └── task.py          # TaskBase, Task, TaskCreate, TaskUpdate, TaskResponse
│   ├── middleware/
│   │   ├── __init__.py
│   │   └── auth.py          # JWT verification: get_current_user, enforce_user_access
│   ├── routes/
│   │   └── __init__.py      # Empty — no task routes in foundation
│   └── services/
│       └── __init__.py      # Empty — no services in foundation
├── pyproject.toml
└── .env.example

frontend/
├── app/
│   └── api/
│       └── auth/
│           └── [...all]/
│               └── route.ts  # Better Auth API handler
├── lib/
│   ├── auth.ts              # Better Auth server config + JWT plugin
│   └── auth-client.ts       # Better Auth client + jwtClient plugin
├── hooks/
│   └── useAuth.ts           # Auth hook (signUp, signIn, signOut, token)
├── package.json
├── tsconfig.json
└── .env.example

# Root
├── .env.example             # Combined reference
└── .gitignore               # Includes .env, .env.local
```

**Structure Decision**: Web application (Option 2). Frontend uses `app/` directly without `src/` prefix. Backend follows the established pattern from SKILL.md.

---

## Implementation Tasks

### Phase 1: Backend Database Layer (Database Agent)

**Agent**: Database Agent | **Skill**: `.claude/skills/database/SKILL.md`

#### Task 1.1: Backend project scaffold
Create `backend/` directory with `pyproject.toml`, `__init__.py` files, and `.env.example`.

**File**: `backend/pyproject.toml`
```toml
[project]
name = "todo-backend"
version = "1.0.0"
requires-python = ">=3.13"
dependencies = [
    "fastapi>=0.115.0",
    "uvicorn[standard]>=0.30.0",
    "sqlmodel>=0.0.22",
    "pyjwt[crypto]>=2.9.0",
    "psycopg2-binary>=2.9.9",
    "python-dotenv>=1.0.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=8.0.0",
    "pytest-asyncio>=0.24.0",
    "httpx>=0.27.0",
]
```

**File**: `backend/.env.example`
```
DATABASE_URL=postgresql://user:password@ep-xxx.neon.tech/todo_db?sslmode=require
BETTER_AUTH_SECRET=your-shared-secret-minimum-32-characters-long
CORS_ORIGINS=http://localhost:3000
```

**Acceptance**: `pyproject.toml` exists, `uv sync` succeeds.

#### Task 1.2: Neon connection setup
**File**: `backend/app/db.py`

- Load `DATABASE_URL` from environment (fail fast if missing)
- Create SQLAlchemy engine with: `pool_pre_ping=True`, `pool_size=5`, `max_overflow=10`, `pool_recycle=300`
- `create_db_and_tables()` calls `SQLModel.metadata.create_all(engine)`
- `get_session()` yields a `Session` for FastAPI dependency injection

Exact implementation: follow `.claude/skills/database/SKILL.md` — Neon Connection Setup section.

**Acceptance**: Engine connects to Neon with SSL. `create_db_and_tables()` runs without error.

#### Task 1.3: Config module
**File**: `backend/app/config.py`

- `Settings` dataclass reading `DATABASE_URL`, `BETTER_AUTH_SECRET`, `CORS_ORIGINS` from env
- Fail fast with clear error if `DATABASE_URL` or `BETTER_AUTH_SECRET` is missing

**Acceptance**: Missing env var raises `ValueError` with descriptive message.

#### Task 1.4: Task SQLModel models
**File**: `backend/app/models/task.py`

Models exactly as defined in database spec and SKILL.md:

| Model | Purpose | Fields |
|-------|---------|--------|
| `TaskBase` | Shared fields | `title` (str, 1-200 chars), `description` (Optional[str], max 1000) |
| `Task` | DB table (`tasks`) | Inherits TaskBase + `id` (int, PK, auto), `user_id` (str, FK→user.id, indexed, CASCADE on delete), `completed` (bool, default False, indexed), `created_at` (datetime UTC), `updated_at` (datetime UTC) |
| `TaskCreate` | Create request schema | Inherits TaskBase (title required, description optional) |
| `TaskUpdate` | Update request schema | `title` (Optional), `description` (Optional) — all optional |
| `TaskResponse` | Response schema | All fields: id, user_id, title, description, completed, created_at, updated_at |

Indexes: `idx_tasks_user_id`, `idx_tasks_completed`, `idx_tasks_created_at`

**Acceptance**: Models import without error. `create_all()` creates `tasks` table with correct columns, constraints, and indexes.

#### Task 1.5: FastAPI app entry point (foundation version)
**File**: `backend/app/main.py`

- Lifespan: call `create_db_and_tables()` on startup
- CORS middleware: read `CORS_ORIGINS` from env, split by comma
- Health check: `GET /health` returns `{"status": "healthy"}`
- NO task routes registered yet
- Load `.env` via `python-dotenv` at module level

**Acceptance**: `uvicorn app.main:app --reload --port 8000` starts, `GET /health` returns 200.

---

### Phase 2: Backend Auth Middleware (Auth Agent)

**Agent**: Auth Agent | **Skill**: `.claude/skills/auth/SKILL.md`

#### Task 2.1: JWT verification middleware
**File**: `backend/app/middleware/auth.py`

- `security = HTTPBearer()` — FastAPI security scheme
- `BETTER_AUTH_SECRET` read from environment
- `get_current_user(credentials)`:
  - Decode JWT with `PyJWT` using HS256
  - Extract `sub` (user_id), `email`, `name` from claims
  - Raise 401 for: expired, invalid, missing `sub`
  - Return dict: `{"user_id": str, "email": str, "name": str}`
- `enforce_user_access(user_id, current_user)`:
  - Compare `current_user["user_id"]` with URL `user_id`
  - Raise 403 if mismatch

Exact implementation: follow `.claude/skills/auth/SKILL.md` — Backend Implementation section.

**Acceptance**: Valid JWT → user dict returned. Expired → 401. Invalid → 401. Wrong user → 403.

---

### Phase 3: Frontend Auth Setup (Auth Agent)

**Agent**: Auth Agent | **Skill**: `.claude/skills/auth/SKILL.md`

#### Task 3.1: Frontend project scaffold
Initialize Next.js 16 project in `frontend/` with TypeScript and Tailwind CSS.

```bash
cd frontend
npx create-next-app@latest . --typescript --tailwind --app --eslint
npm install better-auth pg
```

**File**: `frontend/.env.example`
```
BETTER_AUTH_SECRET=your-shared-secret-minimum-32-characters-long
DATABASE_URL=postgresql://user:password@ep-xxx.neon.tech/todo_db?sslmode=require
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_BETTER_AUTH_URL=http://localhost:3000
```

**Acceptance**: `npm run dev` starts Next.js on port 3000.

#### Task 3.2: Better Auth server config
**File**: `frontend/lib/auth.ts`

```typescript
import { betterAuth } from "better-auth";
import { jwt } from "better-auth/plugins";
import { Pool } from "pg";

export const auth = betterAuth({
  database: new Pool({
    connectionString: process.env.DATABASE_URL,
  }),
  plugins: [jwt()],
  secret: process.env.BETTER_AUTH_SECRET,
  emailAndPassword: {
    enabled: true,
  },
});
```

**Acceptance**: Module imports without error. Better Auth initializes with Neon connection.

#### Task 3.3: Better Auth API route handler
**File**: `frontend/app/api/auth/[...all]/route.ts`

```typescript
import { auth } from "@/lib/auth";
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth.handler);
```

**Acceptance**: `POST /api/auth/sign-up/email` creates a user. `POST /api/auth/sign-in/email` returns session.

#### Task 3.4: Better Auth client
**File**: `frontend/lib/auth-client.ts`

```typescript
import { createAuthClient } from "better-auth/react";
import { jwtClient } from "better-auth/plugins/client";

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_BETTER_AUTH_URL || "http://localhost:3000",
  plugins: [jwtClient()],
});
```

**Acceptance**: Client can call `signUp.email()`, `signIn.email()`, `signOut()`, `token()`.

#### Task 3.5: Auth hook
**File**: `frontend/hooks/useAuth.ts`

```typescript
"use client";
import { authClient } from "@/lib/auth-client";

export function useAuth() {
  const session = authClient.useSession();

  const signUp = async (email: string, password: string, name: string) => {
    return await authClient.signUp.email({ email, password, name });
  };

  const signIn = async (email: string, password: string) => {
    return await authClient.signIn.email({ email, password });
  };

  const signOut = async () => {
    return await authClient.signOut();
  };

  const getToken = async (): Promise<string | null> => {
    const { data } = await authClient.token();
    return data?.token ?? null;
  };

  return {
    session: session.data,
    isLoading: session.isPending,
    isAuthenticated: !!session.data,
    signUp,
    signIn,
    signOut,
    getToken,
  };
}
```

**Acceptance**: Hook provides auth state and methods. `getToken()` returns a JWT string.

---

### Phase 4: Environment & Git Setup

#### Task 4.1: Root .gitignore
Ensure `.gitignore` at repo root includes:
```
.env
.env.local
frontend/.env.local
backend/.env
node_modules/
__pycache__/
*.pyc
.venv/
```

#### Task 4.2: Root .env.example
**File**: `.env.example` (reference only, not loaded by any service)
```
# Shared secret — MUST be identical on frontend and backend
BETTER_AUTH_SECRET=your-shared-secret-minimum-32-characters-long

# Neon PostgreSQL connection — used by both frontend (Better Auth) and backend
DATABASE_URL=postgresql://user:password@ep-xxx.neon.tech/todo_db?sslmode=require

# Frontend only
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_BETTER_AUTH_URL=http://localhost:3000

# Backend only
CORS_ORIGINS=http://localhost:3000
```

---

## Dependency Order

```
Task 1.1 (backend scaffold)
  └→ Task 1.2 (db.py) + Task 1.3 (config.py)
       └→ Task 1.4 (models)
            └→ Task 1.5 (main.py)
                 └→ Task 2.1 (JWT middleware)

Task 3.1 (frontend scaffold)
  └→ Task 3.2 (auth server config)
       └→ Task 3.3 (API route handler)
       └→ Task 3.4 (auth client)
            └→ Task 3.5 (auth hook)

Task 4.1 + 4.2 (env/git) — independent, can run anytime
```

Backend (Phase 1-2) and Frontend (Phase 3) can be developed in parallel after their scaffolds are set up.

---

## Verification Checklist

After all tasks complete, verify:

- [ ] `cd backend && uvicorn app.main:app --port 8000` — starts without error
- [ ] `GET http://localhost:8000/health` — returns `{"status": "healthy"}`
- [ ] `tasks` table exists in Neon with correct schema
- [ ] `cd frontend && npm run dev` — starts on port 3000
- [ ] `POST http://localhost:3000/api/auth/sign-up/email` — creates user
- [ ] `POST http://localhost:3000/api/auth/sign-in/email` — returns session
- [ ] JWT token can be obtained via client `authClient.token()`
- [ ] Backend can verify the JWT token with PyJWT using shared secret
- [ ] No `.env` files committed to git

## Non-Goals (Deferred)

- Task CRUD route handlers (next plan)
- Task service layer (next plan)
- Frontend pages (login, signup, dashboard)
- Frontend API client (`lib/api.ts`)
- Protected route layout
- Tests (testing strategy spec exists but implementation deferred)

## Risks

1. **Better Auth table naming**: Better Auth uses camelCase column names (`emailVerified`, `createdAt`). The `tasks` table uses snake_case. Both coexist in the same database — ensure no conflicts.
2. **`pg` driver on Neon**: The `pg` npm package connects to Neon from the Next.js server runtime. Serverless deployments may need `@neondatabase/serverless` driver instead. Start with `pg` and switch if needed.
3. **JWT algorithm mismatch**: Better Auth signs with HS256 by default. PyJWT must decode with the same algorithm. Hardcode `algorithms=["HS256"]` in the backend.
