<!--
  SYNC IMPACT REPORT
  ==================================================
  Version change: 0.0.0 (template) → 1.0.0
  Bump rationale: MAJOR — first population of constitution
    from blank template; establishes all project governance.

  Modified principles:
    - [PRINCIPLE_1_NAME] → "Spec-Driven Development"
    - [PRINCIPLE_2_NAME] → "No Manual Coding"
    - [PRINCIPLE_3_NAME] → "User Isolation"
    - [PRINCIPLE_4_NAME] → "Clean Architecture"
    - [PRINCIPLE_5_NAME] → "Monorepo Coherence"
    - [PRINCIPLE_6_NAME] → removed (user specified 5 principles)

  Added sections:
    - "Technology Stack" (non-negotiable stack definition)
    - "Architecture Standards" (API, JWT, CORS, env vars)
    - "Agents and Skills" (5 sub-agents, 4 skill files, delegation rules)
    - "Code Quality Standards" (TypeScript, Python, HTTP codes)
    - "Security Standards" (JWT, passwords, SSL, env)
    - "Testing Standards" (pytest, Vitest, coverage matrix)
    - "Spec-Driven Workflow" (mandatory order)
    - "Success Criteria" (hackathon deliverables)
    - "Constraints" (hackathon rules)

  Removed sections:
    - [SECTION_2_NAME] / [SECTION_3_NAME] generic placeholders
      replaced by domain-specific sections above

  Templates requiring updates:
    - .specify/templates/plan-template.md — ✅ no update needed;
      "Constitution Check" section is generic and will be filled
      per-feature referencing principles defined here.
    - .specify/templates/spec-template.md — ✅ no update needed;
      template is technology-agnostic by design.
    - .specify/templates/tasks-template.md — ✅ no update needed;
      web app structure option already present in template.
    - .specify/templates/commands/*.md — N/A (no command files exist)

  Follow-up TODOs: none
  ==================================================
-->

# Phase II Todo Full-Stack Web Application Constitution

## Core Principles

### I. Spec-Driven Development

No code is written without an approved specification. Every line of
code MUST trace back to a specification document in the `specs/`
directory. Specifications are created before implementation begins
and serve as the single source of truth for feature requirements.

- Specs MUST exist in `specs/` before any implementation work starts
- All acceptance criteria MUST be defined in the spec
- If implementation reveals a spec gap, the spec MUST be updated
  first — never patch the code without updating the spec
- Every feature is traceable: spec → plan → tasks → code → test

### II. No Manual Coding

All implementation is generated by Claude Code from specifications
using the appropriate sub-agent and skill file. If output is
incorrect, the spec or prompt MUST be refined — not the code
directly.

- Claude Code generates all code from specs and tasks
- Developers refine specs and prompts, not generated code
- Each agent MUST read its skill file before performing any work
- Manual edits are permitted only for environment configuration
  (`.env` files) and infrastructure that cannot be generated

### III. User Isolation

Every database query, every API response, and every UI view MUST
be scoped to the authenticated user. No user can ever access, view,
modify, or delete another user's data.

- All database queries MUST include a `user_id` filter
- API URL `{user_id}` MUST match the JWT `sub` claim; mismatch
  results in HTTP 403
- Frontend MUST only display data belonging to the session user
- No endpoint may return data across user boundaries
- This principle is NON-NEGOTIABLE and MUST be verified in every
  code review and test suite

### IV. Clean Architecture

The application follows a strict layered architecture: thin route
handlers delegate to a service layer, which performs business logic
and database operations. No business logic in route handlers. No
direct database calls in route handlers.

- Route handlers: parse request, call service, return response
- Service layer: business logic, validation, database queries
- Models: data definitions only (SQLModel tables, Pydantic schemas)
- Pydantic V2 schemas for all API request/response — never expose
  SQLModel table models directly in API responses
- Async route handlers in FastAPI

### V. Monorepo Coherence

Frontend (Next.js 16+) and Backend (FastAPI) live in one repository.
Changes that touch both sides MUST be specified together in a single
spec to prevent contract drift.

- Frontend code lives in `frontend/`
- Backend code lives in `backend/`
- Shared contracts (API shapes, error codes) MUST be documented
- Cross-boundary changes require a unified spec before implementation
- Environment variables MUST be kept in sync across both sides

## Technology Stack

The following technology choices are non-negotiable for this project.

| Layer | Technology |
|-------|-----------|
| Frontend | Next.js 16+ with App Router, TypeScript, Tailwind CSS |
| Backend | Python FastAPI |
| ORM | SQLModel |
| Database | Neon Serverless PostgreSQL (SSL required, `sslmode=require`) |
| Authentication | Better Auth with JWT plugin (frontend) + PyJWT (backend) |
| Shared Secret | `BETTER_AUTH_SECRET` identical on both frontend and backend |
| Package Managers | uv for Python, npm for Node.js |

- No substitutions for core technologies are permitted
- Additional libraries MAY be added if they do not conflict with
  the core stack and are justified in the implementation plan

## Architecture Standards

- **RESTful API**: 6 endpoints under `/api/{user_id}/tasks`
  (GET list, POST create, GET by id, PUT update, DELETE,
  PATCH toggle complete)
- **JWT on every request**: All API endpoints MUST require a valid
  Bearer token. No exceptions.
- **User ID enforcement**: URL `{user_id}` MUST match JWT `sub`
  claim. Mismatch = HTTP 403.
- **CORS**: Backend MUST allow only the frontend origin
- **Environment variables**: All secrets and configuration MUST
  come from `.env` files. Never hardcoded. Never committed to git.

## Agents and Skills

This project uses 5 sub-agents and 4 skill files. Every agent MUST
read its corresponding skill file BEFORE doing any work.

### Sub-Agents

| Agent | Location | Domain |
|-------|----------|--------|
| Auth | `.claude/agents/auth.md` | Signup, signin, signout, JWT, Better Auth |
| Backend | `.claude/agents/backend.md` | FastAPI routes, service layer, CORS, errors |
| Frontend | `.claude/agents/frontend.md` | Next.js pages, components, hooks, styling |
| Database | `.claude/agents/database.md` | Schema, SQLModel models, Neon, queries |
| Testing | `.claude/agents/testing.md` | pytest, Vitest, mock JWT, fixtures |

### Skills

| Skill | Location |
|-------|----------|
| Auth | `.claude/skills/auth/SKILL.md` |
| Backend | `.claude/skills/backend/SKILL.md` |
| Frontend | `.claude/skills/frontend/SKILL.md` |
| Database | `.claude/skills/database/SKILL.md` |

### Delegation Rules

- Authentication work (signup, signin, JWT, Better Auth) →
  Auth Agent
- Route handlers, FastAPI setup, error handling → Backend Agent
- Next.js pages, components, hooks, UI → Frontend Agent
- Schema, models, Neon connection, queries → Database Agent
- Writing tests for any layer → Testing Agent
- Multi-domain tasks MUST be delegated in dependency order:
  Database → Auth (if auth involved) → Backend → Frontend → Testing
- No agent may work outside its domain. If a backend task requires
  a new DB model, the Database Agent MUST handle it first.

## Code Quality Standards

- TypeScript strict mode on frontend — no `any` types
- Type hints on all Python function signatures
- Pydantic V2 models for all request/response schemas
- Server Components by default in Next.js — use `"use client"` only
  when interactivity is required
- All API calls from frontend go through a single API client
  (`lib/api.ts`) — never use direct `fetch` in components
- Async route handlers in FastAPI
- Proper HTTP status codes:
  - 200: GET, PUT, PATCH success
  - 201: POST success (resource created)
  - 204: DELETE success (no content)
  - 401: Missing or invalid token
  - 403: User ID mismatch (wrong user)
  - 404: Resource not found
  - 422: Validation error

## Security Standards

- JWT tokens MUST have an expiry
- Never store JWT in `localStorage` — use httpOnly cookies or
  in-memory storage
- Password hashing MUST be handled by Better Auth (never implement
  custom hashing)
- SSL/TLS MUST be used for all Neon database connections
  (`sslmode=require`)
- `.env.example` MUST be provided with placeholder values
- Real `.env` files MUST be listed in `.gitignore`

## Testing Standards

- **Backend**: pytest + httpx `AsyncClient`, mock JWT tokens,
  SQLite for unit tests
- **Frontend**: Vitest + React Testing Library
- Every endpoint MUST have tests for:
  - Valid request (happy path)
  - Missing token (401)
  - Wrong user (403)
  - Resource not found (404)
  - Invalid input (422)
- No feature is considered complete without passing tests

## Spec-Driven Workflow

Implementation MUST follow this mandatory order:

1. **Constitution** (this file) — project-wide rules and principles
2. **Specify** (`/sp.specify`) — write feature specs with
   acceptance criteria
3. **Plan** (`/sp.plan`) — architecture and implementation decisions
4. **Tasks** (`/sp.tasks`) — atomic, testable work units
5. **Implement** (`/sp.implement`) — Claude Code generates code from
   tasks using the appropriate agent and skill
6. **Test** — verify against acceptance criteria using Testing Agent

## Success Criteria

- All 5 Basic Level features working as a web app (Add, Delete,
  Update, View, Mark Complete)
- User authentication with signup/signin via Better Auth
- JWT-secured REST API with all 6 endpoints
- Data persisted in Neon PostgreSQL
- Frontend deployed on Vercel, backend API accessible
- Every feature traceable from spec → task → code → test
- Demo video under 90 seconds showing all features

## Constraints

- Individual hackathon — no team submissions
- MUST use specified tech stack — no substitutions for core
  technologies
- All specs MUST be committed to git before implementation
- Phase II builds on Phase I concepts but is a new repo with
  web-based implementation

## Governance

This constitution is the highest-authority document for the Phase II
Todo Full-Stack Web Application project. All other documents,
templates, and generated code MUST comply with the principles and
standards defined here.

### Amendment Procedure

1. Proposed amendments MUST be documented with rationale
2. Amendments MUST specify which principle or section is affected
3. Version MUST be incremented per semantic versioning rules:
   - **MAJOR**: Principle removal, redefinition, or backward-
     incompatible governance change
   - **MINOR**: New principle or section added, or material
     expansion of existing guidance
   - **PATCH**: Clarifications, wording fixes, non-semantic
     refinements
4. `LAST_AMENDED_DATE` MUST be updated to the amendment date

### Compliance Review

- All code reviews MUST verify compliance with this constitution
- All specs MUST reference applicable principles
- Agent delegation rules MUST be followed — no bypassing
- Use `CLAUDE.md` for runtime development guidance and agent routing

**Version**: 1.0.0 | **Ratified**: 2026-02-07 | **Last Amended**: 2026-02-07
